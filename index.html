<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกรายการเบิกจ่าย - โรงเรียนบ้านกิ่วพร้าว</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .main-header {
            background: linear-gradient(135deg, #1134A6 0%, #2563eb 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(17, 52, 166, 0.3);
        }
        
        .school-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .system-title {
            font-family: 'Kanit', sans-serif;
            font-weight: 600;
            font-size: 2.2rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .system-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        .nav-tabs {
            border: none;
            margin-bottom: 2rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            background: white;
            color: #1134A6;
            font-weight: 500;
            margin-right: 0.5rem;
            border-radius: 10px 10px 0 0;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link:hover {
            background: #f8f9ff;
            transform: translateY(-2px);
        }
        
        .nav-tabs .nav-link.active {
            background: #1134A6;
            color: white;
            box-shadow: 0 4px 15px rgba(17, 52, 166, 0.3);
        }
        
        .content-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1134A6 0%, #2563eb 100%);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 52, 166, 0.4);
        }
        
        .btn-outline-primary {
            border: 2px solid #1134A6;
            color: #1134A6;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-outline-primary:hover {
            background: #1134A6;
            border-color: #1134A6;
            transform: translateY(-2px);
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .table thead th {
            background: linear-gradient(135deg, #1134A6 0%, #2563eb 100%);
            color: white;
            border: none;
            font-weight: 500;
            padding: 1rem;
        }
        
        .table tbody tr {
            transition: all 0.3s ease;
        }
        
        .table tbody tr:hover {
            background: #f8f9ff;
            transform: scale(1.01);
        }
        
        .modal-content {
            border: none;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #1134A6 0%, #2563eb 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 1.5rem;
        }
        
        .modal-title {
            font-family: 'Kanit', sans-serif;
            font-weight: 600;
        }
        
        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #1134A6;
            box-shadow: 0 0 0 0.2rem rgba(17, 52, 166, 0.25);
        }
        
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1134A6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pagination .page-link {
            border: none;
            color: #1134A6;
            margin: 0 2px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .pagination .page-link:hover {
            background: #1134A6;
            color: white;
            transform: translateY(-2px);
        }
        
        .pagination .page-item.active .page-link {
            background: #1134A6;
            border-color: #1134A6;
        }
        
        .badge {
            font-size: 0.8rem;
            padding: 0.5rem 0.8rem;
            border-radius: 20px;
        }
        
        .filter-section {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid #e9ecef;
        }
        
        @media (max-width: 768px) {
            .system-title {
                font-size: 1.8rem;
            }
            
            .content-card {
                padding: 1rem;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
            
            .modal-dialog {
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <div class="text-white mt-3">กำลังประมวลผล...</div>
        </div>
    </div>

    <!-- Header -->
    <div class="main-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-auto">
                    <img src="https://lh3.googleusercontent.com/d/1vQtWxoqhL4BWuOmDehWMGTqoRh63AThV" alt="โรงเรียนบ้านกิ่วพร้าว" class="school-logo">
                </div>
                <div class="col">
                    <h1 class="system-title">ระบบบันทึกรายการเบิกจ่าย</h1>
                    <p class="system-subtitle">โรงเรียนบ้านกิ่วพร้าว</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="view-tab" data-bs-toggle="tab" data-bs-target="#view-pane" type="button" role="tab">
                    <i class="fas fa-table me-2"></i>ดูรายการเบิกจ่าย
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-pane" type="button" role="tab">
                    <i class="fas fa-plus-circle me-2"></i>บันทึก บจ.ทั่วไป
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="utility-tab" data-bs-toggle="tab" data-bs-target="#utility-pane" type="button" role="tab">
                    <i class="fas fa-bolt me-2"></i>บันทึก บจ.สาธารณูปโภค
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bk-tab" data-bs-toggle="tab" data-bs-target="#bk-pane" type="button" role="tab">
                    <i class="fas fa-file-invoice me-2"></i>บันทึก บค.
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- หน้าดูรายการเบิกจ่าย -->
            <div class="tab-pane fade show active" id="view-pane" role="tabpanel">
                <div class="content-card">
                    <!-- Filter Section -->
                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">เดือน</label>
                                <select class="form-select" id="filterMonth">
                                    <option value="">ทุกเดือน</option>
                                    <option value="1">มกราคม</option>
                                    <option value="2">กุมภาพันธ์</option>
                                    <option value="3">มีนาคม</option>
                                    <option value="4">เมษายน</option>
                                    <option value="5">พฤษภาคม</option>
                                    <option value="6">มิถุนายน</option>
                                    <option value="7">กรกฎาคม</option>
                                    <option value="8">สิงหาคม</option>
                                    <option value="9">กันยายน</option>
                                    <option value="10">ตุลาคม</option>
                                    <option value="11">พฤศจิกายน</option>
                                    <option value="12">ธันวาคม</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ปีงบประมาณ</label>
                                <select class="form-select" id="filterYear">
                                    <option value="">ทุกปี</option>
                                    <option value="2568">2568</option>
                                    <option value="2569">2569</option>
                                    <option value="2570">2570</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ประเภทเอกสาร</label>
                                <select class="form-select" id="filterDocType">
                                    <option value="">ทุกประเภท</option>
                                    <option value="บค.">บค.</option>
                                    <option value="บจ.ทั่วไป">บจ.ทั่วไป</option>
                                    <option value="บจ.สาธารณูปโภค">บจ.สาธารณูปโภค</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end gap-2">
                                <button class="btn btn-primary flex-fill" onclick="filterData()">
                                    <i class="fas fa-search me-2"></i>ค้นหา
                                </button>
                                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exportModal" title="Export เป็น Excel">
                                    <i class="fas fa-file-excel"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tables for different document types -->
                    <div id="tablesContainer">
                        <!-- บค. Table -->
                        <div class="mb-4">
                            <h5 class="mb-3"><i class="fas fa-file-invoice me-2"></i>ตารางประเภทเอกสาร บค.</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>เลขที่เอกสาร</th>
                                            <th>วันที่</th>
                                            <th>โครงการ</th>
                                            <th>รายการ</th>
                                            <th>จำนวนเงิน</th>
                                            <th>การจัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bkTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">ไม่มีข้อมูล</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav>
                                <ul class="pagination justify-content-center" id="bkPagination"></ul>
                            </nav>
                        </div>

                        <!-- บจ.ทั่วไป Table -->
                        <div class="mb-4">
                            <h5 class="mb-3"><i class="fas fa-plus-circle me-2"></i>ตารางประเภทเอกสาร บจ.ทั่วไป</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>เลขที่เอกสาร</th>
                                            <th>วันที่</th>
                                            <th>โครงการ</th>
                                            <th>รายการ</th>
                                            <th>จำนวนเงิน</th>
                                            <th>การจัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="generalTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">ไม่มีข้อมูล</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav>
                                <ul class="pagination justify-content-center" id="generalPagination"></ul>
                            </nav>
                        </div>

                        <!-- บจ.สาธารณูปโภค Table -->
                        <div class="mb-4">
                            <h5 class="mb-3"><i class="fas fa-bolt me-2"></i>ตารางประเภทเอกสาร บจ.สาธารณูปโภค</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>เลขที่เอกสาร</th>
                                            <th>วันที่</th>
                                            <th>รายการ</th>
                                            <th>ประจำเดือน</th>
                                            <th>จำนวนเงิน</th>
                                            <th>การจัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="utilityTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">ไม่มีข้อมูล</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <nav>
                                <ul class="pagination justify-content-center" id="utilityPagination"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- หน้าบันทึก บจ.ทั่วไป -->
            <div class="tab-pane fade" id="general-pane" role="tabpanel">
                <div class="content-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4><i class="fas fa-plus-circle me-2"></i>บันทึกรายการเบิกจ่าย บจ.ทั่วไป</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generalModal">
                            <i class="fas fa-plus me-2"></i>เพิ่มรายการเบิกจ่าย
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>เลขที่เอกสาร</th>
                                    <th>วันที่</th>
                                    <th>โครงการ</th>
                                    <th>รายการ</th>
                                    <th>จำนวนเงิน</th>
                                    <th>การจัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="generalListBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">ไม่มีข้อมูล</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- หน้าบันทึก บจ.สาธารณูปโภค -->
            <div class="tab-pane fade" id="utility-pane" role="tabpanel">
                <div class="content-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4><i class="fas fa-bolt me-2"></i>บันทึกรายการเบิกจ่าย บจ.สาธารณูปโภค</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#utilityModal">
                            <i class="fas fa-plus me-2"></i>เพิ่มรายการเบิกจ่าย
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>เลขที่เอกสาร</th>
                                    <th>วันที่</th>
                                    <th>รายการ</th>
                                    <th>ประจำเดือน</th>
                                    <th>จำนวนเงิน</th>
                                    <th>การจัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="utilityListBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">ไม่มีข้อมูล</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- หน้าบันทึก บค. -->
            <div class="tab-pane fade" id="bk-pane" role="tabpanel">
                <div class="content-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4><i class="fas fa-file-invoice me-2"></i>บันทึกรายการเบิกจ่าย บค.</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bkModal">
                            <i class="fas fa-plus me-2"></i>เพิ่มรายการเบิกจ่าย
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>เลขที่เอกสาร</th>
                                    <th>วันที่</th>
                                    <th>โครงการ</th>
                                    <th>รายการ</th>
                                    <th>จำนวนเงิน</th>
                                    <th>การจัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="bkListBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">ไม่มีข้อมูล</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับ บจ.ทั่วไป -->
    <div class="modal fade" id="generalModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่มรายการเบิกจ่าย บจ.ทั่วไป</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="generalForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">ประเภท</label>
                                <select class="form-select" name="type" required>
                                    <option value="ทั่วไป" selected>ทั่วไป</option>
                                    <option value="สาธารณูปโภค">สาธารณูปโภค</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ประเภทเอกสาร</label>
                                <input type="text" class="form-control" name="docType" value="บจ." required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เลขที่เอกสาร</label>
                                <select class="form-select" name="docNumber" id="generalDocNumber" required>
                                    <option value="">เลือกเลขที่เอกสาร</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ปีงบประมาณ</label>
                                <select class="form-select" name="fiscalYear" required>
                                    <option value="2568">2568</option>
                                    <option value="2569">2569</option>
                                    <option value="2570">2570</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">วันที่</label>
                                <input type="date" class="form-control" name="date" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">โครงการอะไร</label>
                                <input type="text" class="form-control" name="project" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">รายการอะไร</label>
                                <input type="text" class="form-control" name="item" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ร้านค้าหรือผู้ขาย</label>
                                <input type="text" class="form-control" name="vendor" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ประเภทผู้ขาย</label>
                                <select class="form-select" name="vendorType" id="generalVendorType" required>
                                    <option value="">เลือกประเภทผู้ขาย</option>
                                    <option value="นิติบุคคล">นิติบุคคล</option>
                                    <option value="บุคคลธรรมดา">บุคคลธรรมดา</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เลขที่ใบสั่งซื้อหรือสั่งจ้าง</label>
                                <input type="text" class="form-control" name="poNumber">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ใบสั่งลงวันที่</label>
                                <input type="date" class="form-control" name="poDate">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">จำนวนเงิน</label>
                                <input type="number" class="form-control" name="amount" id="generalAmount" step="0.01" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ภาษีมูลค่าเพิ่ม</label>
                                <input type="number" class="form-control" name="vat" id="generalVat" step="0.01" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">มูลค่าสินค้า</label>
                                <input type="number" class="form-control" name="productValue" id="generalProductValue" step="0.01" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ภาษี ณ ที่จ่าย</label>
                                <input type="number" class="form-control" name="withholdingTax" id="generalWithholdingTax" step="0.01" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">คงเหลือจ่ายจริง</label>
                                <input type="number" class="form-control" name="netAmount" id="generalNetAmount" step="0.01" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">คงเหลือจ่ายจริงเป็นตัวหนังสือ</label>
                                <input type="text" class="form-control" name="netAmountText" id="generalNetAmountText" readonly>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveGeneral()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับ บจ.สาธารณูปโภค -->
    <div class="modal fade" id="utilityModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่มรายการเบิกจ่าย บจ.สาธารณูปโภค</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="utilityForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">ประเภท</label>
                                <select class="form-select" name="type" required>
                                    <option value="สาธารณูปโภค" selected>สาธารณูปโภค</option>
                                    <option value="ทั่วไป">ทั่วไป</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ประเภทเอกสาร</label>
                                <input type="text" class="form-control" name="docType" value="บจ." required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เลขที่เอกสาร</label>
                                <select class="form-select" name="docNumber" id="utilityDocNumber" required>
                                    <option value="">เลือกเลขที่เอกสาร</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ปีงบประมาณ</label>
                                <select class="form-select" name="fiscalYear" required>
                                    <option value="2568">2568</option>
                                    <option value="2569">2569</option>
                                    <option value="2570">2570</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">วันที่</label>
                                <input type="date" class="form-control" name="date" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">รายการ</label>
                                <select class="form-select" name="item" required>
                                    <option value="">เลือกรายการ</option>
                                    <option value="ค่าไฟฟ้า">ค่าไฟฟ้า</option>
                                    <option value="ค่าน้ำประปา">ค่าน้ำประปา</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ประจำเดือน</label>
                                <select class="form-select" name="month" required>
                                    <option value="">เลือกเดือน</option>
                                    <option value="มกราคม">มกราคม</option>
                                    <option value="กุมภาพันธ์">กุมภาพันธ์</option>
                                    <option value="มีนาคม">มีนาคม</option>
                                    <option value="เมษายน">เมษายน</option>
                                    <option value="พฤษภาคม">พฤษภาคม</option>
                                    <option value="มิถุนายน">มิถุนายน</option>
                                    <option value="กรกฎาคม">กรกฎาคม</option>
                                    <option value="สิงหาคม">สิงหาคม</option>
                                    <option value="กันยายน">กันยายน</option>
                                    <option value="ตุลาคม">ตุลาคม</option>
                                    <option value="พฤศจิกายน">พฤศจิกายน</option>
                                    <option value="ธันวาคม">ธันวาคม</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">หน่วยงาน</label>
                                <select class="form-select" name="agency" id="utilityAgency" required>
                                    <option value="">เลือกหน่วยงาน</option>
                                    <option value="เทศบาลตำบลจันจว้า">เทศบาลตำบลจันจว้า</option>
                                    <option value="การไฟฟ้าส่วนภูมิภาคสาขาอำเภอแม่จัน">การไฟฟ้าส่วนภูมิภาคสาขาอำเภอแม่จัน</option>
                                    <option value="อื่นๆ">อื่นๆ</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="customAgencyDiv" style="display: none;">
                                <label class="form-label">ระบุหน่วยงาน</label>
                                <input type="text" class="form-control" name="customAgency" id="customAgency">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">หมายเลขใบแจ้งหนี้</label>
                                <input type="text" class="form-control" name="billNumber" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">จำนวนเงิน</label>
                                <input type="number" class="form-control" name="amount" id="utilityAmount" step="0.01" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">จำนวนเงินเป็นตัวหนังสือ</label>
                                <input type="text" class="form-control" name="amountText" id="utilityAmountText" readonly>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveUtility()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับ บค. -->
    <div class="modal fade" id="bkModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เพิ่มรายการเบิกจ่าย บค.</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bkForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">ประเภทเอกสาร</label>
                                <input type="text" class="form-control" name="docType" value="บค." required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เลขที่เอกสาร</label>
                                <input type="text" class="form-control" name="docNumber" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ปีงบประมาณ</label>
                                <select class="form-select" name="fiscalYear" required>
                                    <option value="2568">2568</option>
                                    <option value="2569">2569</option>
                                    <option value="2570">2570</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">วันที่</label>
                                <input type="date" class="form-control" name="date" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">โครงการอะไร</label>
                                <input type="text" class="form-control" name="project" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">รายการอะไร</label>
                                <input type="text" class="form-control" name="item" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ร้านค้าหรือผู้ขาย</label>
                                <input type="text" class="form-control" name="vendor" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ประเภทผู้ขาย</label>
                                <select class="form-select" name="vendorType" id="bkVendorType" required>
                                    <option value="">เลือกประเภทผู้ขาย</option>
                                    <option value="นิติบุคคล">นิติบุคคล</option>
                                    <option value="บุคคลธรรมดา">บุคคลธรรมดา</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">เลขที่ใบสั่งซื้อหรือสั่งจ้าง</label>
                                <input type="text" class="form-control" name="poNumber">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ใบสั่งลงวันที่</label>
                                <input type="date" class="form-control" name="poDate">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">จำนวนเงิน</label>
                                <input type="number" class="form-control" name="amount" id="bkAmount" step="0.01" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ภาษีมูลค่าเพิ่ม</label>
                                <input type="number" class="form-control" name="vat" id="bkVat" step="0.01" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">มูลค่าสินค้า</label>
                                <input type="number" class="form-control" name="productValue" id="bkProductValue" step="0.01" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ภาษี ณ ที่จ่าย</label>
                                <input type="number" class="form-control" name="withholdingTax" id="bkWithholdingTax" step="0.01" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">คงเหลือจ่ายจริง</label>
                                <input type="number" class="form-control" name="netAmount" id="bkNetAmount" step="0.01" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">คงเหลือจ่ายจริงเป็นตัวหนังสือ</label>
                                <input type="text" class="form-control" name="netAmountText" id="bkNetAmountText" readonly>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveBk()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">รายละเอียดการเบิกจ่าย</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <!-- Detail content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-excel me-2"></i>Export ข้อมูลเป็น Excel</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="exportForm">
                        <div class="mb-3">
                            <label class="form-label">เลือกปีงบประมาณที่ต้องการ Export</label>
                            <select class="form-select" id="exportYear" required>
                                <option value="">เลือกปีงบประมาณ</option>
                                <option value="2568">2568</option>
                                <option value="2569">2569</option>
                                <option value="2570">2570</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">เลือกประเภทเอกสาร</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportBk" value="บค." checked>
                                <label class="form-check-label" for="exportBk">บค.</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportGeneral" value="บจ.ทั่วไป" checked>
                                <label class="form-check-label" for="exportGeneral">บจ.ทั่วไป</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportUtility" value="บจ.สาธารณูปโภค" checked>
                                <label class="form-check-label" for="exportUtility">บจ.สาธารณูปโภค</label>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            ระบบจะสร้างไฟล์ Excel พร้อมแยกแท็บตามประเภทเอกสารที่เลือก
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-success" onclick="exportToExcel()">
                        <i class="fas fa-download me-2"></i>Export Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Global variables
        const API_URL = 'https://script.google.com/macros/s/AKfycbw5qUde9RqhaOKzPclnLDCXaY2vnYRxW1R8hr8fjuqgnHc9atMNshxUM2sTtp0ET2xj/exec';
        let allData = [];
        let usedDocNumbers = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
            generateDocNumbers();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Amount calculation for general form
            document.getElementById('generalAmount').addEventListener('input', function() {
                calculateGeneral();
            });
            
            document.getElementById('generalVendorType').addEventListener('change', function() {
                calculateGeneral();
            });

            // Amount calculation for BK form
            document.getElementById('bkAmount').addEventListener('input', function() {
                calculateBk();
            });
            
            document.getElementById('bkVendorType').addEventListener('change', function() {
                calculateBk();
            });

            // Amount to text for utility form
            document.getElementById('utilityAmount').addEventListener('input', function() {
                const amount = parseFloat(this.value) || 0;
                document.getElementById('utilityAmountText').value = numberToThaiText(amount);
            });

            // Custom agency field toggle
            document.getElementById('utilityAgency').addEventListener('change', function() {
                const customDiv = document.getElementById('customAgencyDiv');
                if (this.value === 'อื่นๆ') {
                    customDiv.style.display = 'block';
                    document.getElementById('customAgency').required = true;
                } else {
                    customDiv.style.display = 'none';
                    document.getElementById('customAgency').required = false;
                }
            });
        }

        // Generate document numbers (01-300)
        function generateDocNumbers() {
            const generalSelect = document.getElementById('generalDocNumber');
            const utilitySelect = document.getElementById('utilityDocNumber');
            
            for (let i = 1; i <= 300; i++) {
                const number = i.toString().padStart(2, '0');
                if (!usedDocNumbers.includes(number)) {
                    const option1 = new Option(number, number);
                    const option2 = new Option(number, number);
                    generalSelect.add(option1);
                    utilitySelect.add(option2);
                }
            }
        }

        // Load data from Google Sheets
        async function loadData() {
            showLoading();
            try {
                const response = await fetch(`${API_URL}?action=getData`);
                const data = await response.json();
                
                if (data.success) {
                    allData = data.data || [];
                    usedDocNumbers = data.usedDocNumbers || [];
                    updateTables();
                    updateDocNumberOptions();
                } else {
                    throw new Error(data.message || 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถโหลดข้อมูลได้ กรุณาลองใหม่อีกครั้ง'
                });
            } finally {
                hideLoading();
            }
        }

        // Update document number options
        function updateDocNumberOptions() {
            const generalSelect = document.getElementById('generalDocNumber');
            const utilitySelect = document.getElementById('utilityDocNumber');
            
            // Clear existing options
            generalSelect.innerHTML = '<option value="">เลือกเลขที่เอกสาร</option>';
            utilitySelect.innerHTML = '<option value="">เลือกเลขที่เอกสาร</option>';
            
            // Add available numbers
            for (let i = 1; i <= 300; i++) {
                const number = i.toString().padStart(2, '0');
                if (!usedDocNumbers.includes(number)) {
                    const option1 = new Option(number, number);
                    const option2 = new Option(number, number);
                    generalSelect.add(option1);
                    utilitySelect.add(option2);
                }
            }
        }

        // Update all tables
        function updateTables() {
            updateTable('bk', 'bkTableBody', 'bkPagination');
            updateTable('general', 'generalTableBody', 'generalPagination');
            updateTable('utility', 'utilityTableBody', 'utilityPagination');
            updateTable('general', 'generalListBody');
            updateTable('utility', 'utilityListBody');
            updateTable('bk', 'bkListBody');
        }

        // Update specific table
        function updateTable(type, bodyId, paginationId = null) {
            const tbody = document.getElementById(bodyId);
            const filteredData = filterDataByType(type);
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">ไม่มีข้อมูล</td></tr>';
                if (paginationId) {
                    document.getElementById(paginationId).innerHTML = '';
                }
                return;
            }

            // Sort by document number (latest first)
            filteredData.sort((a, b) => {
                const numA = parseInt(a.docNumber) || 0;
                const numB = parseInt(b.docNumber) || 0;
                return numB - numA;
            });

            const itemsPerPage = 20;
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const currentPage = 1; // For simplicity, always show first page

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            let html = '';
            pageData.forEach((item, index) => {
                html += `
                    <tr>
                        <td>${item.docNumber}</td>
                        <td>${formatDate(item.date)}</td>
                        <td>${type === 'utility' ? item.item : item.project}</td>
                        <td>${type === 'utility' ? item.month : item.item}</td>
                        <td>${formatCurrency(item.amount)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewDetail('${item.id}')">
                                <img src="https://lh3.googleusercontent.com/d/13qxaLbH33ivpbfIfrBmylnxINq1oOLFl" width="16" height="16" class="me-1"> ดู
                            </button>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="editItem('${item.id}')">
                                <img src="https://lh3.googleusercontent.com/d/1J08fhv8_Lqe1O1YY4nQTSl-0WKNo3FnU" width="16" height="16" class="me-1"> แก้ไข
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${item.id}')">
                                <img src="https://lh3.googleusercontent.com/d/1CE-tDsLaAhEd3TGz877i7N3AIiYRjDlq" width="16" height="16" class="me-1"> ลบ
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Update pagination if provided
            if (paginationId && totalPages > 1) {
                updatePagination(paginationId, currentPage, totalPages);
            }
        }

        // Filter data by type
        function filterDataByType(type) {
            return allData.filter(item => {
                if (type === 'bk') return item.docType === 'บค.';
                if (type === 'general') return item.docType === 'บจ.' && item.type === 'ทั่วไป';
                if (type === 'utility') return item.docType === 'บจ.' && item.type === 'สาธารณูปโภค';
                return false;
            });
        }

        // Filter data based on selected criteria
        function filterData() {
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;
            const docType = document.getElementById('filterDocType').value;

            // Apply filters and update tables
            updateTables();
        }

        // Calculate values for general form
        function calculateGeneral() {
            const amount = parseFloat(document.getElementById('generalAmount').value) || 0;
            const vendorType = document.getElementById('generalVendorType').value;
            
            let vat = 0;
            let withholdingTax = 0;
            
            if (vendorType === 'นิติบุคคล') {
                vat = amount * 7 / 107;
                if (amount >= 500) {
                    withholdingTax = (amount * 100 / 107) * 0.01;
                }
            } else if (vendorType === 'บุคคลธรรมดา') {
                if (amount >= 10000) {
                    withholdingTax = amount * 0.01;
                }
            }
            
            // Round withholding tax to 2 decimal places with proper rounding
            withholdingTax = Math.round(withholdingTax * 100) / 100;
            
            const productValue = amount - vat;
            const netAmount = amount - withholdingTax;
            
            document.getElementById('generalVat').value = vat.toFixed(2);
            document.getElementById('generalProductValue').value = productValue.toFixed(2);
            document.getElementById('generalWithholdingTax').value = withholdingTax.toFixed(2);
            document.getElementById('generalNetAmount').value = netAmount.toFixed(2);
            document.getElementById('generalNetAmountText').value = numberToThaiText(netAmount);
        }

        // Calculate values for BK form
        function calculateBk() {
            const amount = parseFloat(document.getElementById('bkAmount').value) || 0;
            const vendorType = document.getElementById('bkVendorType').value;
            
            let vat = 0;
            let withholdingTax = 0;
            
            if (vendorType === 'นิติบุคคล') {
                vat = amount * 7 / 107;
                if (amount >= 500) {
                    withholdingTax = (amount * 100 / 107) * 0.01;
                }
            } else if (vendorType === 'บุคคลธรรมดา') {
                if (amount >= 10000) {
                    withholdingTax = amount * 0.01;
                }
            }
            
            // Round withholding tax to 2 decimal places with proper rounding
            withholdingTax = Math.round(withholdingTax * 100) / 100;
            
            const productValue = amount - vat;
            const netAmount = amount - withholdingTax;
            
            document.getElementById('bkVat').value = vat.toFixed(2);
            document.getElementById('bkProductValue').value = productValue.toFixed(2);
            document.getElementById('bkWithholdingTax').value = withholdingTax.toFixed(2);
            document.getElementById('bkNetAmount').value = netAmount.toFixed(2);
            document.getElementById('bkNetAmountText').value = numberToThaiText(netAmount);
        }

        // Convert number to Thai text
        function numberToThaiText(num) {
            const ones = ['', 'หนึ่ง', 'สอง', 'สาม', 'สี่', 'ห้า', 'หก', 'เจ็ด', 'แปด', 'เก้า'];
            const tens = ['', '', 'ยี่', 'สาม', 'สี่', 'ห้า', 'หก', 'เจ็ด', 'แปด', 'เก้า'];
            const units = ['', 'สิบ', 'ร้อย', 'พัน', 'หมื่น', 'แสน', 'ล้าน'];
            
            if (num === 0) return 'ศูนย์บาท';
            
            const [integerPart, decimalPart] = num.toString().split('.');
            let result = '';
            
            // Convert integer part
            const digits = integerPart.split('').reverse();
            for (let i = 0; i < digits.length; i++) {
                const digit = parseInt(digits[i]);
                if (digit === 0) continue;
                
                if (i === 1 && digit === 1) {
                    result = 'สิบ' + result;
                } else if (i === 1 && digit === 2) {
                    result = 'ยี่สิบ' + result;
                } else {
                    result = ones[digit] + units[i] + result;
                }
            }
            
            result += 'บาท';
            
            // Convert decimal part
            if (decimalPart && parseInt(decimalPart) > 0) {
                const satang = parseInt(decimalPart.padEnd(2, '0').substring(0, 2));
                if (satang > 0) {
                    result += numberToThaiText(satang).replace('บาท', '') + 'สตางค์';
                }
            } else {
                result += 'ถ้วน';
            }
            
            return result;
        }

        // Save general form
        async function saveGeneral() {
            const form = document.getElementById('generalForm');
            const formData = new FormData(form);
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            showLoading();
            
            try {
                const params = new URLSearchParams();
                const isEdit = form.dataset.editId;
                params.append('action', isEdit ? 'updateGeneral' : 'saveGeneral');
                
                if (isEdit) {
                    params.append('id', form.dataset.editId);
                }
                
                for (let [key, value] of formData.entries()) {
                    params.append(key, value);
                }
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: isEdit ? 'แก้ไขสำเร็จ' : 'บันทึกสำเร็จ',
                        text: isEdit ? 'แก้ไขข้อมูลเรียบร้อยแล้ว' : 'บันทึกข้อมูลเรียบร้อยแล้ว'
                    });
                    
                    form.reset();
                    delete form.dataset.editId;
                    document.querySelector('#generalModal .modal-title').textContent = 'เพิ่มรายการเบิกจ่าย บจ.ทั่วไป';
                    bootstrap.Modal.getInstance(document.getElementById('generalModal')).hide();
                    loadData();
                } else {
                    throw new Error(result.message || 'เกิดข้อผิดพลาดในการบันทึก');
                }
            } catch (error) {
                console.error('Error saving general:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message || 'ไม่สามารถบันทึกข้อมูลได้'
                });
            } finally {
                hideLoading();
            }
        }

        // Save utility form
        async function saveUtility() {
            const form = document.getElementById('utilityForm');
            const formData = new FormData(form);
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            showLoading();
            
            try {
                const params = new URLSearchParams();
                const isEdit = form.dataset.editId;
                params.append('action', isEdit ? 'updateUtility' : 'saveUtility');
                
                if (isEdit) {
                    params.append('id', form.dataset.editId);
                }
                
                for (let [key, value] of formData.entries()) {
                    params.append(key, value);
                }
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: isEdit ? 'แก้ไขสำเร็จ' : 'บันทึกสำเร็จ',
                        text: isEdit ? 'แก้ไขข้อมูลเรียบร้อยแล้ว' : 'บันทึกข้อมูลเรียบร้อยแล้ว'
                    });
                    
                    form.reset();
                    delete form.dataset.editId;
                    document.querySelector('#utilityModal .modal-title').textContent = 'เพิ่มรายการเบิกจ่าย บจ.สาธารณูปโภค';
                    bootstrap.Modal.getInstance(document.getElementById('utilityModal')).hide();
                    loadData();
                } else {
                    throw new Error(result.message || 'เกิดข้อผิดพลาดในการบันทึก');
                }
            } catch (error) {
                console.error('Error saving utility:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message || 'ไม่สามารถบันทึกข้อมูลได้'
                });
            } finally {
                hideLoading();
            }
        }

        // Save BK form
        async function saveBk() {
            const form = document.getElementById('bkForm');
            const formData = new FormData(form);
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            showLoading();
            
            try {
                const params = new URLSearchParams();
                const isEdit = form.dataset.editId;
                params.append('action', isEdit ? 'updateBk' : 'saveBk');
                
                if (isEdit) {
                    params.append('id', form.dataset.editId);
                }
                
                for (let [key, value] of formData.entries()) {
                    params.append(key, value);
                }
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: params
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: isEdit ? 'แก้ไขสำเร็จ' : 'บันทึกสำเร็จ',
                        text: isEdit ? 'แก้ไขข้อมูลเรียบร้อยแล้ว' : 'บันทึกข้อมูลเรียบร้อยแล้ว'
                    });
                    
                    form.reset();
                    delete form.dataset.editId;
                    document.querySelector('#bkModal .modal-title').textContent = 'เพิ่มรายการเบิกจ่าย บค.';
                    bootstrap.Modal.getInstance(document.getElementById('bkModal')).hide();
                    loadData();
                } else {
                    throw new Error(result.message || 'เกิดข้อผิดพลาดในการบันทึก');
                }
            } catch (error) {
                console.error('Error saving BK:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: error.message || 'ไม่สามารถบันทึกข้อมูลได้'
                });
            } finally {
                hideLoading();
            }
        }

        // View detail
        function viewDetail(id) {
            const item = allData.find(d => d.id === id);
            if (!item) return;
            
            let html = '<div class="row g-3">';
            
            Object.keys(item).forEach(key => {
                if (key !== 'id') {
                    const label = getFieldLabel(key);
                    const value = formatFieldValue(key, item[key]);
                    html += `
                        <div class="col-md-6">
                            <label class="form-label fw-bold">${label}</label>
                            <div class="form-control-plaintext border rounded p-2 bg-light">${value}</div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            document.getElementById('detailModalBody').innerHTML = html;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // Edit item
        function editItem(id) {
            const item = allData.find(d => d.id === id);
            if (!item) return;
            
            if (item.docType === 'บค.') {
                // Fill BK form
                const form = document.getElementById('bkForm');
                form.querySelector('[name="docType"]').value = item.docType || '';
                form.querySelector('[name="docNumber"]').value = item.docNumber || '';
                form.querySelector('[name="fiscalYear"]').value = item.fiscalYear || '';
                form.querySelector('[name="date"]').value = item.date || '';
                form.querySelector('[name="project"]').value = item.project || '';
                form.querySelector('[name="item"]').value = item.item || '';
                form.querySelector('[name="vendor"]').value = item.vendor || '';
                form.querySelector('[name="vendorType"]').value = item.vendorType || '';
                form.querySelector('[name="poNumber"]').value = item.poNumber || '';
                form.querySelector('[name="poDate"]').value = item.poDate || '';
                form.querySelector('[name="amount"]').value = item.amount || '';
                
                // Set edit mode
                form.dataset.editId = id;
                document.querySelector('#bkModal .modal-title').textContent = 'แก้ไขรายการเบิกจ่าย บค.';
                
                // Trigger calculations
                calculateBk();
                
                new bootstrap.Modal(document.getElementById('bkModal')).show();
            } else if (item.docType === 'บจ.' && item.type === 'ทั่วไป') {
                // Fill General form
                const form = document.getElementById('generalForm');
                form.querySelector('[name="type"]').value = item.type || '';
                form.querySelector('[name="docType"]').value = item.docType || '';
                form.querySelector('[name="docNumber"]').value = item.docNumber || '';
                form.querySelector('[name="fiscalYear"]').value = item.fiscalYear || '';
                form.querySelector('[name="date"]').value = item.date || '';
                form.querySelector('[name="project"]').value = item.project || '';
                form.querySelector('[name="item"]').value = item.item || '';
                form.querySelector('[name="vendor"]').value = item.vendor || '';
                form.querySelector('[name="vendorType"]').value = item.vendorType || '';
                form.querySelector('[name="poNumber"]').value = item.poNumber || '';
                form.querySelector('[name="poDate"]').value = item.poDate || '';
                form.querySelector('[name="amount"]').value = item.amount || '';
                
                // Set edit mode
                form.dataset.editId = id;
                document.querySelector('#generalModal .modal-title').textContent = 'แก้ไขรายการเบิกจ่าย บจ.ทั่วไป';
                
                // Trigger calculations
                calculateGeneral();
                
                new bootstrap.Modal(document.getElementById('generalModal')).show();
            } else if (item.docType === 'บจ.' && item.type === 'สาธารณูปโภค') {
                // Fill Utility form
                const form = document.getElementById('utilityForm');
                form.querySelector('[name="type"]').value = item.type || '';
                form.querySelector('[name="docType"]').value = item.docType || '';
                form.querySelector('[name="docNumber"]').value = item.docNumber || '';
                form.querySelector('[name="fiscalYear"]').value = item.fiscalYear || '';
                form.querySelector('[name="date"]').value = item.date || '';
                form.querySelector('[name="item"]').value = item.item || '';
                form.querySelector('[name="month"]').value = item.month || '';
                form.querySelector('[name="agency"]').value = item.agency || '';
                form.querySelector('[name="billNumber"]').value = item.billNumber || '';
                form.querySelector('[name="amount"]').value = item.amount || '';
                
                // Handle custom agency
                if (item.agency === 'อื่นๆ' && item.customAgency) {
                    document.getElementById('customAgencyDiv').style.display = 'block';
                    form.querySelector('[name="customAgency"]').value = item.customAgency;
                }
                
                // Set edit mode
                form.dataset.editId = id;
                document.querySelector('#utilityModal .modal-title').textContent = 'แก้ไขรายการเบิกจ่าย บจ.สาธารณูปโภค';
                
                // Trigger amount to text conversion
                const amount = parseFloat(item.amount) || 0;
                document.getElementById('utilityAmountText').value = numberToThaiText(amount);
                
                new bootstrap.Modal(document.getElementById('utilityModal')).show();
            }
        }

        // Delete item
        async function deleteItem(id) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบ',
                text: 'คุณต้องการลบรายการนี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });

            if (result.isConfirmed) {
                showLoading();
                
                try {
                    const params = new URLSearchParams();
                    params.append('action', 'delete');
                    params.append('id', id);
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: params
                    });
                    
                    const deleteResult = await response.json();
                    
                    if (deleteResult.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'ลบสำเร็จ',
                            text: 'ลบรายการเรียบร้อยแล้ว'
                        });
                        loadData();
                    } else {
                        throw new Error(deleteResult.message || 'เกิดข้อผิดพลาดในการลบ');
                    }
                } catch (error) {
                    console.error('Error deleting item:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: error.message || 'ไม่สามารถลบรายการได้'
                    });
                } finally {
                    hideLoading();
                }
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH');
        }

        function formatCurrency(amount) {
            if (!amount) return '0.00';
            return parseFloat(amount).toLocaleString('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function getFieldLabel(key) {
            const labels = {
                docType: 'ประเภทเอกสาร',
                docNumber: 'เลขที่เอกสาร',
                fiscalYear: 'ปีงบประมาณ',
                date: 'วันที่',
                project: 'โครงการ',
                item: 'รายการ',
                vendor: 'ผู้ขาย',
                vendorType: 'ประเภทผู้ขาย',
                amount: 'จำนวนเงิน',
                type: 'ประเภท',
                month: 'ประจำเดือน',
                agency: 'หน่วยงาน',
                billNumber: 'หมายเลขใบแจ้งหนี้'
            };
            return labels[key] || key;
        }

        function formatFieldValue(key, value) {
            if (key === 'amount') {
                return formatCurrency(value) + ' บาท';
            }
            if (key === 'date') {
                return formatDate(value);
            }
            return value || '';
        }

        function updatePagination(paginationId, currentPage, totalPages) {
            const pagination = document.getElementById(paginationId);
            let html = '';
            
            // Previous button
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ก่อนหน้า</a>
                     </li>`;
            
            // Page numbers
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                         </li>`;
            }
            
            if (totalPages > 5) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                html += `<li class="page-item">
                            <a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>
                         </li>`;
            }
            
            // Next button
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ถัดไป</a>
                     </li>`;
            
            pagination.innerHTML = html;
        }

        function changePage(page) {
            // Implement page change logic here
            console.log('Change to page:', page);
        }

        // Export to Excel function
        async function exportToExcel() {
            const exportYear = document.getElementById('exportYear').value;
            const exportBk = document.getElementById('exportBk').checked;
            const exportGeneral = document.getElementById('exportGeneral').checked;
            const exportUtility = document.getElementById('exportUtility').checked;

            if (!exportYear) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกปีงบประมาณ',
                    text: 'โปรดเลือกปีงบประมาณที่ต้องการ Export'
                });
                return;
            }

            if (!exportBk && !exportGeneral && !exportUtility) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณาเลือกประเภทเอกสาร',
                    text: 'โปรดเลือกประเภทเอกสารอย่างน้อย 1 ประเภท'
                });
                return;
            }

            showLoading();

            try {
                // Filter data by selected year
                const yearData = allData.filter(item => item.fiscalYear === exportYear);

                if (yearData.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'ไม่มีข้อมูล',
                        text: `ไม่พบข้อมูลในปีงบประมาณ ${exportYear}`
                    });
                    return;
                }

                // Create workbook
                const wb = XLSX.utils.book_new();

                // Export BK data
                if (exportBk) {
                    const bkData = yearData.filter(item => item.docType === 'บค.');
                    if (bkData.length > 0) {
                        const bkSheet = createBkSheet(bkData);
                        XLSX.utils.book_append_sheet(wb, bkSheet, 'บค.');
                    }
                }

                // Export General data
                if (exportGeneral) {
                    const generalData = yearData.filter(item => item.docType === 'บจ.' && item.type === 'ทั่วไป');
                    if (generalData.length > 0) {
                        const generalSheet = createGeneralSheet(generalData);
                        XLSX.utils.book_append_sheet(wb, generalSheet, 'บจ.ทั่วไป');
                    }
                }

                // Export Utility data
                if (exportUtility) {
                    const utilityData = yearData.filter(item => item.docType === 'บจ.' && item.type === 'สาธารณูปโภค');
                    if (utilityData.length > 0) {
                        const utilitySheet = createUtilitySheet(utilityData);
                        XLSX.utils.book_append_sheet(wb, utilitySheet, 'บจ.สาธารณูปโภค');
                    }
                }

                // Generate filename
                const filename = `รายการเบิกจ่าย_ปีงบประมาณ${exportYear}_${new Date().toISOString().slice(0, 10)}.xlsx`;

                // Save file
                XLSX.writeFile(wb, filename);

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();

                Swal.fire({
                    icon: 'success',
                    title: 'Export สำเร็จ',
                    text: `ไฟล์ ${filename} ถูกดาวน์โหลดเรียบร้อยแล้ว`
                });

            } catch (error) {
                console.error('Export error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถ Export ไฟล์ได้ กรุณาลองใหม่อีกครั้ง'
                });
            } finally {
                hideLoading();
            }
        }

        // Create BK sheet
        function createBkSheet(data) {
            const headers = [
                'เลขที่เอกสาร',
                'วันที่',
                'โครงการ',
                'รายการ',
                'ผู้ขาย',
                'ประเภทผู้ขาย',
                'เลขที่ใบสั่งซื้อ',
                'วันที่ใบสั่ง',
                'จำนวนเงิน',
                'ภาษีมูลค่าเพิ่ม',
                'มูลค่าสินค้า',
                'ภาษี ณ ที่จ่าย',
                'คงเหลือจ่ายจริง',
                'คงเหลือจ่ายจริง (ตัวหนังสือ)'
            ];

            const rows = data.map(item => [
                item.docNumber || '',
                formatDateForExcel(item.date) || '',
                item.project || '',
                item.item || '',
                item.vendor || '',
                item.vendorType || '',
                item.poNumber || '',
                formatDateForExcel(item.poDate) || '',
                parseFloat(item.amount) || 0,
                parseFloat(item.vat) || 0,
                parseFloat(item.productValue) || 0,
                parseFloat(item.withholdingTax) || 0,
                parseFloat(item.netAmount) || 0,
                item.netAmountText || ''
            ]);

            const wsData = [headers, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Set column widths
            ws['!cols'] = [
                { width: 15 }, // เลขที่เอกสาร
                { width: 12 }, // วันที่
                { width: 25 }, // โครงการ
                { width: 25 }, // รายการ
                { width: 20 }, // ผู้ขาย
                { width: 15 }, // ประเภทผู้ขาย
                { width: 15 }, // เลขที่ใบสั่งซื้อ
                { width: 12 }, // วันที่ใบสั่ง
                { width: 15 }, // จำนวนเงิน
                { width: 15 }, // ภาษีมูลค่าเพิ่ม
                { width: 15 }, // มูลค่าสินค้า
                { width: 15 }, // ภาษี ณ ที่จ่าย
                { width: 15 }, // คงเหลือจ่ายจริง
                { width: 30 }  // คงเหลือจ่ายจริง (ตัวหนังสือ)
            ];

            return ws;
        }

        // Create General sheet
        function createGeneralSheet(data) {
            const headers = [
                'เลขที่เอกสาร',
                'วันที่',
                'โครงการ',
                'รายการ',
                'ผู้ขาย',
                'ประเภทผู้ขาย',
                'เลขที่ใบสั่งซื้อ',
                'วันที่ใบสั่ง',
                'จำนวนเงิน',
                'ภาษีมูลค่าเพิ่ม',
                'มูลค่าสินค้า',
                'ภาษี ณ ที่จ่าย',
                'คงเหลือจ่ายจริง',
                'คงเหลือจ่ายจริง (ตัวหนังสือ)'
            ];

            const rows = data.map(item => [
                item.docNumber || '',
                formatDateForExcel(item.date) || '',
                item.project || '',
                item.item || '',
                item.vendor || '',
                item.vendorType || '',
                item.poNumber || '',
                formatDateForExcel(item.poDate) || '',
                parseFloat(item.amount) || 0,
                parseFloat(item.vat) || 0,
                parseFloat(item.productValue) || 0,
                parseFloat(item.withholdingTax) || 0,
                parseFloat(item.netAmount) || 0,
                item.netAmountText || ''
            ]);

            const wsData = [headers, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Set column widths
            ws['!cols'] = [
                { width: 15 }, // เลขที่เอกสาร
                { width: 12 }, // วันที่
                { width: 25 }, // โครงการ
                { width: 25 }, // รายการ
                { width: 20 }, // ผู้ขาย
                { width: 15 }, // ประเภทผู้ขาย
                { width: 15 }, // เลขที่ใบสั่งซื้อ
                { width: 12 }, // วันที่ใบสั่ง
                { width: 15 }, // จำนวนเงิน
                { width: 15 }, // ภาษีมูลค่าเพิ่ม
                { width: 15 }, // มูลค่าสินค้า
                { width: 15 }, // ภาษี ณ ที่จ่าย
                { width: 15 }, // คงเหลือจ่ายจริง
                { width: 30 }  // คงเหลือจ่ายจริง (ตัวหนังสือ)
            ];

            return ws;
        }

        // Create Utility sheet
        function createUtilitySheet(data) {
            const headers = [
                'เลขที่เอกสาร',
                'วันที่',
                'รายการ',
                'ประจำเดือน',
                'หน่วยงาน',
                'หมายเลขใบแจ้งหนี้',
                'จำนวนเงิน',
                'จำนวนเงิน (ตัวหนังสือ)'
            ];

            const rows = data.map(item => [
                item.docNumber || '',
                formatDateForExcel(item.date) || '',
                item.item || '',
                item.month || '',
                item.customAgency || item.agency || '',
                item.billNumber || '',
                parseFloat(item.amount) || 0,
                item.amountText || ''
            ]);

            const wsData = [headers, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Set column widths
            ws['!cols'] = [
                { width: 15 }, // เลขที่เอกสาร
                { width: 12 }, // วันที่
                { width: 20 }, // รายการ
                { width: 15 }, // ประจำเดือน
                { width: 30 }, // หน่วยงาน
                { width: 20 }, // หมายเลขใบแจ้งหนี้
                { width: 15 }, // จำนวนเงิน
                { width: 30 }  // จำนวนเงิน (ตัวหนังสือ)
            ];

            return ws;
        }

        // Format date for Excel
        function formatDateForExcel(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9847c05997757334',t:'MTc1ODc3NDI2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
